---
title: "ERphagy_FigureGeneration1"
author: "Ian Smith"
date: "2023-02-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## iNeuron Autophagy


### Package load

```{r}
library(tidyverse)
library(ggpubr)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(ggrepel)
library(purrr)
'%!in%' <- function(x,y)!('%in%'(x,y))

filePath <- rstudioapi::getSourceEditorContext()$path
baseDir <- dirname(filePath)

```


## Organelle annotation import

```{r}
## import site localizations
ss_organelle_list<-read.csv(file.path(baseDir, "ss_organelle_list2_wh_annotation_cytoAddedBasedGO_ERannotation.csv"))

#tidy form annotations for localizations
ss_organelle_list<-ss_organelle_list%>%
  tidyr::gather("Compartment_ss","Gene.Symbol",1:23)%>%
  dplyr::filter(!is.na(Gene.Symbol), Gene.Symbol != "")

## all locales with er sub
sub_all_er<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER","ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated","ER.Receptors"   ,"Trans.Golgi","Cis.Golgi","ERGIC"   )
###just er basic
simp_all_er<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER"  )
## er basic with some sub-compartment
sub_all_er_more<- c("Golgi", "Lysosome","Mitochondria","Plasma.Membrane","Endosome","Peroxisome",
               "Nucleus","Cytosol","ER","ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated"  )


### references for mapping
organelle_input_er_split <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% sub_all_er )

organelle_input_er_simple <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% simp_all_er )

organelle_input_er_more <- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% sub_all_er_more )


```


## Figure 1 Data 



### Alban Differentiation dataset

Generate heatmaps to Alban's differentation data.

```{r}
## import results from Alban's neurodiff data
ao_data<-read.csv(file.path(baseDir, "data/ShinyApp_hotelling_results.csv"))
## left join simple localizations
diff_df_full<-left_join(ao_data,organelle_input_er_simple,by="Gene.Symbol", relationship = "many-to-many")%>%
  distinct()
## left join ER sub compartments and only grab ER related proteins
diff_df_full_erOnly<-left_join(ao_data,organelle_input_er_split,by="Gene.Symbol", relationship = "many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))

### write supplement output
# write.csv(diff_df_full_erOnly, file.path(baseDir, "output/SuppData_Diff_erOnly.csv"))

# write.csv(diff_df_full, file.path(baseDir, "output/SuppData_Diff_allData.csv"))

## append localizations and extract normalized quant data
ao_data_tidy<-ao_data%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,
                d0_1,d0_2,d1_1,d1_2,d2_1,d2_2,d4_1,d4_2,
                d6_1,d6_2,d8_1,d8_2,d10_1,d10_2,d12_1,d12_2)%>%
  dplyr::left_join(.,organelle_input_er_simple, by="Gene.Symbol", relationship = "many-to-many")%>%
  dplyr::filter(Compartment_ss =="ER")
  

only_er<- c("ER.Lumen","ER.high.curvature","ER.high.sheet",
               "ER.Membrane","ER.Membrane.associated","ER.Receptors"   )
## remove redundancy/duplicate entries (use this er list for high curvature results)
only_er_list<- ss_organelle_list %>% dplyr::filter(Compartment_ss %in% only_er )%>%
  dplyr::mutate(to_remove = paste(Gene.Symbol,Compartment_ss))%>%
  dplyr::filter(to_remove %!in%  c("RRBP1 ER.Membrane","KTN1 ER.Lumen","RETREG1 ER.high.curvature",
                                   "RETREG2 ER.high.curvature","RETREG3 ER.high.curvature",
                                   "ATL3 ER.high.curvature","RTN3 ER.high.curvature","FAM134A ER.high.curvature",
                                   "FAM134B ER.high.curvature","FAM134C ER.high.curvature"))%>%
  dplyr::select(-to_remove)

### insert order of factors by localization 

only_er_list$Compartment_ss <-factor(only_er_list$Compartment_ss,
                                     levels = c("ER.high.curvature","ER.high.sheet" ,"ER.Lumen",
                                                "ER.Membrane","ER.Membrane.associated","ER.Receptors"   ))


## extract localization data
ao_data_tidy<-ao_data_tidy%>%
  dplyr::select(-Compartment_ss)%>%
  dplyr::left_join(.,only_er_list, by="Gene.Symbol")%>%
  ##calculate average FC from average at day12 and day0
  dplyr::mutate(d12tod0 = (d12_1+d12_2)/2 - (d0_1+d0_2)/2)%>%
  ##group by compartment then d12tod0
  dplyr::arrange(Compartment_ss, d12tod0)%>%
  dplyr::distinct()%>%
  tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank= as.numeric(as.character(Rank)))

### normalize to WT day 0

##capture all quant data for heatmap of all ER
ao_data_tidy2<-ao_data%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,
                d0_1,d0_2,d1_1,d1_2,d2_1,d2_2,d4_1,d4_2,
                d6_1,d6_2,d8_1,d8_2,d10_1,d10_2,d12_1,d12_2)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:19)%>%
  dplyr::left_join(.,organelle_input_er_simple, by="Gene.Symbol", relationship = "many-to-many")%>%
  dplyr::filter(Compartment_ss =="ER")%>%
  dplyr::distinct()


ao_data_tidy2$sample <- factor(ao_data_tidy2$sample,levels = c("d0_1","d0_2","d1_1","d1_2","d2_1","d2_2","d4_1","d4_2",
                "d6_1","d6_2","d8_1","d8_2","d10_1","d10_2","d12_1","d12_2"))
### heatmap input of all ER data
heatmap_input<-ao_data_tidy2%>%
      tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
      dplyr::ungroup()%>%
      dplyr::group_by(ProtID)%>%
      dplyr::mutate(mean_row = mean(log2_int),
             sd_row = sd(log2_int),
             z_scale = (log2_int - mean_row)/sd_row,
             mean_scale = log2_int - mean_row)
## values for day0 to normalize quant for heatmap
heatmap_input_scale_t0<-ao_data_tidy2%>%
  dplyr::filter(sample == "d0_1"|sample == "d0_2")%>%
      tidyr::unite("ProtID", c(Reference,Gene.Symbol,Annotation),sep="__X__")%>%
      dplyr::ungroup()%>%
      dplyr::group_by(ProtID)%>%
      dplyr::summarise(mean_row_d0 = mean(log2_int))

##normalize to day0 here
heatmap_input_scale_D0_join<- dplyr::left_join(heatmap_input,heatmap_input_scale_t0,by="ProtID" )%>%
  dplyr::mutate(d0_scale_value = log2_int - mean_row_d0)
##generate heatmap input for figure
heatmap_input2<-heatmap_input_scale_D0_join%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  tibble::column_to_rownames("ProtID")
#compartment annotations added for the heatmap
annotation<-heatmap_input_scale_D0_join%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value)%>%
  dplyr::group_by(ProtID)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")
## add annotation
annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$protein

annotation_heatmap <- annotation%>%
  select(protein,3:18)%>%
  column_to_rownames("protein")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$protein, Annotation=annotation$Compartment_ss)
library(RColorBrewer)

# create colors aesthetics for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

test<-pheatmap(annotation_heatmap, cluster_cols = F,  annotation_row = anno,show_rownames=F, color=myColor, breaks=myBreaks)

ggsave(test,filename=file.path(baseDir, "figures/ExtDataFig1b_ER_diff_protein_heatmap_all.pdf"),height = 14,width=8)
```


### Most changing from d0 to d12

```{r}

## average FC at day12
d12_changers <-heatmap_input_scale_D0_join%>%
  dplyr::filter(sample == "d12_1" | sample == "d12_2")%>%
  group_by(ProtID)%>%
  summarise(mean_d12_change = mean(d0_scale_value))

## arrange by day12 fc
d12_changers <-d12_changers%>%
  dplyr::arrange(mean_d12_change)

## fold change attachments
d12_input <- left_join(heatmap_input_scale_D0_join, d12_changers, by="ProtID")


bottom25<-d12_changers[1:50,]%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank=as.numeric(as.character(Rank)))


top25<-d12_changers[272:321,]%>%
  tibble::rowid_to_column("Rank")%>%
  dplyr::mutate(Rank=as.numeric(as.character(Rank)))


top25_data<- heatmap_input_scale_D0_join %>% dplyr::filter(ProtID %in%top25$ProtID )%>%
  dplyr::arrange(desc(d0_scale_value))

bottom25_data<- heatmap_input_scale_D0_join %>% dplyr::filter(ProtID %in%bottom25$ProtID )%>%
  dplyr::arrange(d0_scale_value)

bottom25_data<- inner_join(heatmap_input_scale_D0_join,bottom25,by="ProtID")%>%
  dplyr::arrange(Rank)

top25_data<- inner_join(heatmap_input_scale_D0_join,top25,by="ProtID")%>%
  dplyr::arrange(Rank)


receptors<- organelle_input_er_split%>%
  filter(Compartment_ss == "ER.Receptors")%>%
  filter(Gene.Symbol %in% c("TEX264","CCPG1","SEC62"))

high<-organelle_input_er_split%>%
  filter(Compartment_ss %in% c("ER.high.sheet","ER.high.curvature"))

high <- bind_rows(high,receptors)




high_curve <- heatmap_input_scale_D0_join%>%
  mutate(dup = ProtID)%>%
  separate(dup ,  c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  select(-Compartment_ss)%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  select(-Reference,-Gene.Symbol,-Annotation)

#new

  
high_data<- inner_join(heatmap_input_scale_D0_join,high_curve,by="ProtID", relationship="many-to-many")%>%
  distinct()

```


### high curve heatmap

```{r}
 

annotation<-high_curve%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,d0_scale_value, Compartment_ss)%>%
  dplyr::group_by(ProtID,Compartment_ss)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  separate(Reference , into = c("type","Reference","Annotation"),sep="\\|")%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  arrange(Compartment_ss,Gene.Symbol)


annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$protein



annotation_heatmap <- annotation%>%
  ungroup()%>%
  select(protein,6:21)%>%
  column_to_rownames("protein")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$protein, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)

# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-3, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength,3, length.out=floor(paletteLength/2)))

annotation_heatmap<-annotation_heatmap


df_col_ann <- data.frame("sample"= colnames(annotation)[6:21], values = c("d0","d0","d1","d1","d2","d2","d4","d4","d6","d6","d8","d8","d10","d10","d12","d12"))

df_col_ann$values <- factor(df_col_ann$values, levels = c("d0","d1","d2","d4","d6","d8","d10","d12"))
annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F, color=myColor,annotation_row = anno,annotation = annoD, breaks=myBreaks, border_color = FALSE)



#ggsave(test,filename=file.path(baseDir, "figures/Fig1b_heatmap_highcurveSheet_receptors.pdf",height = 6.5,width=8))


```




### top50 differentiation heatmap

```{r}
 

heatmap_input2<-top25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  tidyr::separate(ProtID,c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation,-Reference)%>%
  dplyr::group_by(Gene.Symbol,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(Rank)%>%
  dplyr::ungroup()%>%
  dplyr::select(-Rank)%>%
  tibble::column_to_rownames("Gene.Symbol")

annotation<-top25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  dplyr::group_by(ProtID,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(desc(Rank))%>%
  dplyr::ungroup()%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
  arrange(Compartment_ss)

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$Gene.Symbol



annotation_heatmap <- annotation%>%
  select(Gene.Symbol,3:19)%>%
  column_to_rownames("Gene.Symbol")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$Gene.Symbol, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

annotation_heatmap<-annotation_heatmap%>%
  select(-Rank)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F,annotation_row = anno, color=myColor, breaks=myBreaks, border_color = FALSE)



#ggsave(test,filename=file.path(baseDir, "figures/Fig1a_ER_top50up_diff_protein_heatmap_all.pdf",height = 10,width=8))


```

### bottom50 differentiation heatmap

```{r}
 

heatmap_input2<-bottom25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  tidyr::separate(ProtID,c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation,-Reference)%>%
  dplyr::group_by(Gene.Symbol,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange(Rank)%>%
  dplyr::ungroup()%>%
  dplyr::select(-Rank)%>%
  tibble::column_to_rownames("Gene.Symbol")

annotation<-bottom25_data%>%
  dplyr::ungroup()%>%
  dplyr::select(ProtID,sample,Rank,d0_scale_value)%>%
  dplyr::group_by(ProtID,Rank)%>%
  tidyr::spread(sample,d0_scale_value)%>%
  arrange((Rank))%>%
  dplyr::ungroup()%>%
  tidyr::separate(ProtID, into=c("Reference","Gene.Symbol","Annotation"),sep="__X__")%>%
  dplyr::select(-Annotation)%>%
  dplyr::mutate(protein = paste(Gene.Symbol,Reference,sep="_"))%>%
  dplyr::left_join(.,only_er_list,by="Gene.Symbol")%>%
  arrange(Compartment_ss)

annotation_df<-annotation%>%
  dplyr::select(Compartment_ss)%>%
  dplyr::rename(Var1 = Compartment_ss)

rownames(annotation_df) <- annotation$Gene.Symbol



annotation_heatmap <- annotation%>%
  select(Gene.Symbol,3:19)%>%
  column_to_rownames("Gene.Symbol")

rownames(annotation_df) <- rownames(annotation_heatmap)


# add group annotation
anno<-data.frame(row.names=annotation$Gene.Symbol, Annotation=annotation$Compartment_ss)
library(RColorBrewer)


# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(anno$Annotation))))
annoCol <- newCols(length(unique(anno$Annotation)))
names(annoCol) <- unique(anno$Annotation)
annoCol <- list(category = annoCol)



paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
# use floor and ceiling to deal with even/odd length pallettelengths
myBreaks <- c(seq(-4, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 4, length.out=floor(paletteLength/2)))

annotation_heatmap<-annotation_heatmap%>%
  select(-Rank)

test<-pheatmap(annotation_heatmap, cluster_cols = F,  cluster_rows = F,annotation_row = anno, color=myColor, breaks=myBreaks,border_color = FALSE)


ggsave(test,filename=file.path(baseDir, "figures/Fig1a_ER_down50down_diff_protein_heatmap_all.pdf",height = 10,width=8))



```

## Single KO data

### Import data

```{r}
singles <- read.csv(file.path(baseDir, "data/all_ttest_results_WTATG12singles.csv"))


singles_df_full<-left_join(singles,organelle_input_er_simple,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()


singles_df_full_erOnly<-left_join(singles,organelle_input_er_split,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


# write.csv(singles_df_full_erOnly, file.path(baseDir, "output/SuppData_singlesKO_erOnly.csv"))
# 
# write.csv(singles_df_full, file.path(baseDir, "output/SuppData_singlesKO_allData.csv"))



### extract normalized quant data
singles_slim<-singles%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,99:116)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:21)%>%
  dplyr::mutate(cellLine=dplyr::if_else(str_detect(sample,"WT"),0,1))%>%
  dplyr::ungroup()



## extract WT data and calculate WT mean value for normalizing to WT
wt_Only_singles_slim<-singles_slim%>%
  dplyr::filter(cellLine==0)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(mean_wt0 = mean(log2_int))

###normalize to WT condition data
singles_norm<-left_join(singles_slim,wt_Only_singles_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)
##maintain order of the plex
singles_norm$sample <- factor(singles_norm$sample,
                              levels=c("WT_1","WT_2","WT_3",
                                       "ATG12_1","ATG12_2","ATG12_3",
                                       "CCPG1_1","CCPG1_2","CCPG1_3",
                                       "TEX264_1","TEX264_2","TEX264_3",
                                       "FAM134A_1","FAM134A_2",
                                       "FAM134B_1","FAM134B_2",
                                       "FAM134C_1","FAM134C_2" ))



```


### heatmap Singles er

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
high$Compartment_ss<-factor(high$Compartment_ss,levels=c("ER.high.curvature","ER.high.sheet","ER.Receptors" ))

## extract er high curve proteins data for the singles normalized
er_raw<-singles_norm%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))

## high curve heat map
all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB<-er_raw %>%
  select(ProtID, Compartment_ss)

## annotation of the treatments in the heatmap
df_col_ann <- data.frame("sample"= colnames(er_raw)[3:20], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12",
                                                                "CCPG1","CCPG1","CCPG1",
                                                                "TEX264","TEX264","TEX264",
                                                                "FAM134A","FAM134A",
                                                                "FAM134B","FAM134B",
                                                                "FAM134C","FAM134C"))
annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)
annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap)

test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = file.path(baseDir, "figures/Fig5c_singlets_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5))

```



### Single ER accumulation plots violin by compartment


```{r}

## extract organellar FC data to WT
singles_fc<-singles%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with("WT"))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))

singles_fc$Condition <- factor(singles_fc$Condition, levels=c("ATG12","CCPG1","TEX264","FAM134A", "FAM134B","FAM134C"))



## generate violin plot for all organelles and FC for singlet KO to WT

plot1<-ggplot(singles_fc%>%filter(!is.na(Compartment_ss),Compartment_ss != "ER high sheet", Compartment_ss %!in% c("ER high curvature","ER Lumen","ER Membrane","ER Membrane associated"),Condition != "ATG12")%>%
         filter(Gene.Symbol != Condition), aes(fill=Condition,x=" ", y=FCval))+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8)+
  theme_classic()+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "top",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss,nrow=3)+ylim(c(-1.5,1.5))+ guides(fill = guide_legend(nrow = 1))+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))


plot1

# ggsave(plot = plot1, filename = file.path(baseDir, "figures/ExtDataFig6a_singlets_violin_organelle_accum.pdf", height = 12,width=14))


### ER substructure


pv_fc_er_singles<-ggplot(singles_fc%>%filter(!is.na(Compartment_ss),Compartment_ss != "ER high sheet", Compartment_ss %in% c("ER Lumen","ER Membrane","ER Membrane associated","ER"),Condition != "ATG12", Gene.Symbol != Condition)%>%
         filter(Gene.Symbol != Condition), aes(fill=Condition,x=" ", y=FCval))+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8)+
  theme_classic()+facet_wrap(.~Compartment_ss,nrow=1)+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  scale_color_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  labs(x="",y=bquote(""~Log[2]~"(KO/WT)"))+ylim(c(-1.5,2.5))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))

pv_fc_er_singles

# ggsave(plot = pv_fc_er_singles, filename = file.path(baseDir, "figures/Fig4a_Singles_KO_accum_ERonly_violin_FC.pdf", height = 6,width=12))
```




## Additive KO data

Sample set contains     

```{r}
# USER INPUT
numberOfSamples <- 16

d12_plexa<- read.csv(file.path(baseDir, "data/WTATG12pentad_20_ttest_results.csv"))
numberOfCols <- ncol(d12_plexa)

d12_plexa_slim<-d12_plexa%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,(numberOfCols - numberOfSamples + 1):numberOfCols)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:(4 + numberOfSamples-1))%>%
  dplyr::mutate(cellLine=dplyr::if_else(str_detect(sample,"WT"),0,1))%>%
  dplyr::ungroup()

### calculate mean WT intensity for nmomalization
wt_Only_d12_plexa_slim<-d12_plexa_slim%>%
  dplyr::filter(cellLine==0)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(mean_wt0 = mean(log2_int))

### mean WT subtract form replicate values sans ATG12
norm_d12_plex<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)%>%
  filter(str_detect(sample,"ATG12")==F)

### same as above but with ATG12
norm_d12_plex2<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

```

### Violin plots for organelle differences

```{r}
# USER INPUT
wildType <- "WTd20"
conditions <- c("ATG12","pentaA2","pentaE4")
figurePrefix <- "FigNewSupd20"
conditionFilter <- "d20"

## FC extraction

accum_fc<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove_all(Condition, conditionFilter),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))

accum_fc$Condition <- factor(accum_fc$Condition, 
                             levels=conditions)


### ER only

norm_d12_plex2_ann2<-accum_fc%>%
  filter(str_detect(Compartment_ss,"ER")==T, Compartment_ss != "ERGIC",Compartment_ss != "ER high sheet",Compartment_ss != "ER Receptors",Compartment_ss != "ER high curvature")%>%
         mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "))

norm_d12_plex2_ann2$Condition <- factor(norm_d12_plex2_ann2$Condition,levels=conditions)


pv_fc_er<-ggplot(norm_d12_plex2_ann2%>%filter(Gene.Symbol %!in% c("FAM134C","FAM134B","FAM134A","TEX264","CCPG1"))%>%filter(Condition != "WTd12"), aes(" ", FCval, color=Condition,fill=Condition))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss, nrow=1)+ylim(c(-1.5,2.5))
pv_fc_er

ggsave(plot = pv_fc_er, filename = file.path(baseDir, "figures", paste(figurePrefix, "_KO_accum_ERonly_violin_FC.pdf", sep = "")), height = 6,width=12)

## all locale


norm_d12_plex2_ann4<-accum_fc%>%
  filter( Compartment_ss %in% c("Cytosol","Endosome","ER",
                                "Golgi","Lysosome","Mitochondria",
                                "Nucleus","Peroxisome","Plasma Membrane"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels=conditions)


pv_fc_all<-ggplot(norm_d12_plex2_ann4, aes(" ", FCval, color=Condition,fill=Condition))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  scale_color_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "top",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss,nrow=3)+ylim(c(-1.5,1.5))+ guides(fill = guide_legend(nrow = 1))

pv_fc_all

ggsave(plot = pv_fc_all, filename = file.path(baseDir, "figures", paste(figurePrefix, "_KO_accum_AllOrganelles_violin_FC_nopoints.pdf", sep = "")), height = 12,width=14)

```

### ATG12 only effect

Heatmap showing foldchange related to ATG12 effect compared to WT

```{r}

norm_d12_plex2$sample<-factor(norm_d12_plex2$sample,levels=c("WTd12_1","WTd12_2","WTd12_3",          "ATG12d12_1","ATG12d12_2","ATG12d12_3","CAd12_1","CAd12_2","CAd12_3","CABd12_1","CABd12_2","CABd12_3","CABTEXd12_1","CABTEXd12_2","CABTEXd12_3","CABTEXCCPG1d12_1","CABTEXCCPG1d12_2", "CABTEXCCPG1d12_3"))

high$Compartment_ss <-factor(high$Compartment_ss , levels = c("ER.Receptors","ER.high.curvature","ER.high.sheet"     ))

##extract high curvature, high sheet, receptor protein data for heatmap
er_raw<-norm_d12_plex2%>%
  filter(str_detect(sample,"WT") |str_detect(sample,"ATG12") )%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))

#convert to pheatmap input
all_dataB_heatmap <- er_raw %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")
##annotate rows
annotation_allB<-er_raw %>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw)[3:8], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12"))

df_col_ann$values <- factor(df_col_ann$values, levels=c("WT","ATG12"))

annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# create colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap)
## generate heatmap
test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = file.path(baseDir, "figures/Fig1e_accumdataset_ATG12only_heatmap_ERhc_ERhs.pdf", height = 4.5,width=5))
```





### All ER heatmap Log2FC

Heatmap showing foldchange related to ATG12 effect compared to WT

```{r}

norm_d12_plex2$sample<-factor(norm_d12_plex2$sample,levels=c("WTd12_1","WTd12_2","WTd12_3",          "ATG12d12_1","ATG12d12_2","ATG12d12_3","CAd12_1","CAd12_2","CAd12_3","CABd12_1","CABd12_2","CABd12_3","CABTEXd12_1","CABTEXd12_2","CABTEXd12_3","CABTEXCCPG1d12_1","CABTEXCCPG1d12_2", "CABTEXCCPG1d12_3"))

high$Compartment_ss <-factor(high$Compartment_ss , levels = c("ER.Receptors","ER.high.curvature","ER.high.sheet"     ))



er_only_proteins<-organelle_input_er_split%>%
  filter(str_detect(Compartment_ss,"ER"))%>%
  filter(Compartment_ss != "ER", Compartment_ss != "ERGIC" ,Compartment_ss !="ER.Receptors")

##extract high curvature, high sheet, receptor protein data for heatmap
er_raw_all<-norm_d12_plex2%>%
  # filter(str_detect(sample,"WT") |str_detect(sample,"ATG12") )%>%
  inner_join(.,er_only_proteins,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  mutate(Compartment2=Compartment)%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession,Compartment2),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))

#convert to pheatmap input
all_dataB_heatmap <- er_raw_all %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")
##annotate rows
annotation_allB<-er_raw_all %>%
  select(ProtID, Compartment_ss)

df_col_ann <- data.frame("sample"= colnames(er_raw_all)[3:20], values = c("WT","WT","WT",
                                                                "ATG12","ATG12","ATG12",
                                                                "DKO","DKO","DKO",
                                                                "TKO","TKO","TKO",
                                                                "QKO","QKO","QKO",
                                                                "PKO","PKO","PKO"))

df_col_ann$values <- factor(df_col_ann$values, levels=c("WT","ATG12","DKO","TKO","QKO","PKO"))

annoB<-data.frame(row.names=annotation_allB$ProtID, Annotation=annotation_allB$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann$sample, Condition=df_col_ann$values)

# create colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap)
## generate heatmap
test<-pheatmap(all_dataB_heatmap, cluster_cols = F,  annotation_row = annoB, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = T,show_rownames=F)

# ggsave(plot = test, filename = file.path(baseDir, "figures/ExtDataFig6c_accumdataset_AllCond_heatmap_ER.pdf", height = 10,width=7))
```






### ATG12 effect violins


```{r}
### ATG12 vs WT via ER sub-compartment break down
norm_d12_plex2_ann4<-accum_fc%>%
  filter(str_detect(Compartment_ss,"ER")==T, Compartment_ss %in% c("ER","ER high curvature","ER Membrane","ER Membrane associated","ER Lumen"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels = c("WT","ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))

norm_d12_plex2_ann4%>%
  distinct(Reference,Compartment_ss)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

er_atg12_violin<-ggplot(norm_d12_plex2_ann4%>%
         filter(Condition =="ATG12"), aes(Compartment_ss, FCval, color=Compartment_ss,fill=Compartment_ss))+
  geom_jitter(alpha=0.2,color="black")+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.75, position = position_dodge(),color="black")+
  theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values = c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  scale_color_manual(values=c("#C29BA3","#C9EBEF","lightgreen","#FFCCB6","#69A6D1"))+
  labs(x="",y=bquote(""~Log[2]~"(ATG12 KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))

er_atg12_violin

# ggsave(plot = er_atg12_violin, filename = file.path(baseDir, "figures/Fig1d_accumdataset_ATG12only_ERonly_violin_FC.pdf", height = 6,width=8))


### all locales violin plot

norm_d12_plex2_ann4<-accum_fc%>%
  filter(Compartment_ss %in% c("ER","Peroxisome","Endosome", "Golgi","Plasma Membrane","Nucleus","Cytosol","Mitochondria","Lysosome"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels = c("WT","ATG12","CA","CAB","CABTEX","CABTEXCCPG1"))

##generate counts for the break down
norm_d12_plex2_ann4%>%
  distinct(Reference,Compartment_ss)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

all_atg12_violin<-ggplot(norm_d12_plex2_ann4%>%
         filter(Condition =="ATG12"), aes(Compartment_ss, FCval, color=Compartment_ss,fill=Compartment_ss))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.75, position = position_dodge(),color="black")+
  theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_viridis_d(direction=-1)+
  labs(x="",y=bquote(""~Log[2]~"(ATG12 KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+ylim(c(-1,1))

all_atg12_violin

# ggsave(plot = all_atg12_violin, filename = file.path(baseDir, "figures/ExtDataFig1d_accumdataset_ATG12only_AllOrganelle_violin_FC.pdf", height = 6,width=10))


###
accum_fc<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove_all(Condition,"d12"),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))


high_curve <- organelle_input_er_split%>%filter(Compartment_ss == "ER.high.curvature")

eronly<-organelle_input_er_split%>%filter(Compartment_ss == "ER")

slim_atg<-d12_plexa %>%
  select(Reference,Gene.Symbol,Annotation,log2FC_ATG12d12.WTd12,q.val_ATG12d12.WTd12,sig_ATG12d12.WTd12)


d12_plexa_annotation <- d12_plexa%>%
  mutate(Annotation_vol = if_else(Gene.Symbol %in% c("ATG16L1","ATG5","RB1CC1","ATG12","STX17","RAB33B","ATG10"), "down_autophagy",
                                  if_else(Gene.Symbol %in%  c("GABARAPL1","GABARAPL2","SQSTM1","SEC62","TAX1BP1","MAP1LC3B1","MAP1LC3B2","MAP1LC3A1","CALCOCO1","CALCOCO2","AKAP11","TEX264"), "up_autophagy", if_else(Gene.Symbol %in% c(high_curve$Gene.Symbol), "high_curve",if_else(Gene.Symbol %in% c("CKAP4","KTN1","RRBP1"), "high_sheet",if_else(Gene.Symbol %in% c(eronly$Gene.Symbol),"ER","neither"))))))
    


fig1_atg12_volcano<-ggplot(d12_plexa_annotation%>%filter(Annotation_vol == "neither"), aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12)))+
  geom_point(color="honeydew3", alpha=0.4)+
  geom_point(data=d12_plexa_annotation%>%filter(Annotation_vol != "neither"),aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12),color=Annotation_vol))+
  theme_classic()+
  scale_color_manual(values=c("#542788","darkolivegreen4","mediumvioletred","lightslateblue","#B35806"))+
  geom_text_repel(data=d12_plexa_annotation%>%filter(Annotation_vol != "neither" , Annotation_vol != "ER"), aes(log2FC_ATG12d12.WTd12,-log10(q.val_ATG12d12.WTd12),  label=Gene.Symbol,color=Annotation_vol),size=4, max.overlaps = Inf,box.padding = 1 ,show.legend = FALSE)+
  geom_hline(yintercept = -log10(0.05),linetype="dashed")+
  geom_vline(xintercept = log2(1.5),linetype="dashed")+
  geom_vline(xintercept = -log2(1.5),linetype="dashed")+
  labs(x= bquote(""~Log[2]~"(ATG12 KO / WT)"),
       y= bquote("-"~Log[10]~"(q-value)"))+
  theme(legend.title = element_blank(),
        axis.title = element_text(size=18),
        axis.text = element_text(size=16))
fig1_atg12_volcano
  
# ggsave(plot = fig1_atg12_volcano, filename = file.path(baseDir, "figures/Fig1c_accumdataset_ATG12only_VolcanoPlot.pdf", height = 6,width=10))
```



### Linear Model code

Generate linear additive model

#### Build contrast matrix

Contrast matrix to generate the linear model. Append this to data and use lm function in model. We use indicator/dummy variables to conduct the linear model. Also known as "one-hot encoding" to handle qualitative predictors, which we apply to this linear model. Given the binary nature of the classifiers, we can use dummy variables 1= contain KO(s) or 0 = does not contain KO(s). Further description of model explained in the manuscripts methods.

```{r}
sample_list<-unique(norm_d12_plex$sample)

sample_list<-str_remove_all(sample_list,"d12")

contrast_matrix<-data.frame("sample" = sample_list,
                            "FAM134AC" =            c( 0,0,0, 1,1,1, 1,1,1, 1,1,1, 1,1,1),
                            "FAM134ABC"=            c( 0,0,0, 0,0,0, 1,1,1, 1,1,1, 1,1,1),
                            "FAM134ABCTEX"=        c( 0,0,0, 0,0,0, 0,0,0, 1,1,1, 1,1,1),
                            "FAM134ABCTEXCCPG1"=  c( 0,0,0, 0,0,0, 0,0,0, 0,0,0, 1,1,1)
                    )%>%
  mutate(samp = str_sub(sample,1,-3))

contrast_matrix

```


#### perform test

```{r}
##append contrast matrix to WT normalized data
combine_df_complete<-norm_d12_plex %>%
  group_by(Reference,Gene.Symbol,Annotation,sample,log2_int_wtd0_norm)%>%
  mutate(sample = str_remove(sample,"d12"))%>%
  left_join(.,contrast_matrix,by="sample")

combine_df_complete$samp <- factor(combine_df_complete$samp , levels= c("WT","CA" , "CAB" , "CABTEX" , "CABTEXCCPG1"))

## nest data for protein-level linear model fit
nest_df<-combine_df_complete%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  nest()

## linear model as function of the classifiers defined above
linear_fit_fun <- function(data){
  input<-data.frame(data)
  model<-lm(data=input,log2_int_wtd0_norm ~   FAM134AC + FAM134ABC + FAM134ABCTEX + FAM134ABCTEXCCPG1)
  #summary(model)
  ## generate dataframe that appends the linear model beta estimates and p-values
  lm_results<-data.frame(coeff = summary(model)$coefficients[1:5,1],p.value = summary(model)$coefficients[1:5,4])%>%
    rownames_to_column("Contrast")%>%
    mutate(Contrast = as.character(Contrast))
  return(lm_results) 
}

#perform linear model using the above function
nest_df2<-nest_df%>%
  mutate(lm_results = data %>% map(linear_fit_fun))

## pivot data to untidy data type
convert_long<-function(lm_results){
  df<-data.frame(lm_results)
  df_all<-df%>%
    pivot_wider( 
            names_from = Contrast, 
            values_from = c(coeff,p.value ))
  return(df_all)
}

### convert linear results to untidy format which we unnest
nest_df3<-nest_df2%>%
  mutate(results= lm_results %>% map(convert_long))%>%
  unnest(results)%>%
  select(-data, -lm_results)%>%
  distinct()

##perform Benjamini-Hochberg adjustment to p-values to control for multiple hypotheses
nest_df3$q.value_FAM134AC <- p.adjust(nest_df3$p.value_FAM134AC,method="fdr")
nest_df3$q.value_FAM134ABC <- p.adjust(nest_df3$p.value_FAM134ABC,method="fdr")
nest_df3$q.value_FAM134ABCTEX <- p.adjust(nest_df3$p.value_FAM134ABCTEX,method="fdr")
nest_df3$q.value_FAM134ABCTEXCCPG1 <- p.adjust(nest_df3$p.value_FAM134ABCTEXCCPG1,method="fdr")
##arrange based on penta
nest_df4<-nest_df3%>%
  arrange(coeff_FAM134ABCTEXCCPG1)

## generate dataframe just with coefficents
nest_df4_tidy_coef<-nest_df4%>%
  unite("ProtID",c(Reference,Gene.Symbol,Annotation), sep="__X__")%>%
  select(ProtID,coeff_FAM134AC,coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  group_by(ProtID)%>%
  gather("coeff_CellLine","value",2:5)
## annotate with organelle locations
nest_df4_ann<-nest_df4%>%
  left_join(.,organelle_input_er_simple, by="Gene.Symbol", relationship="many-to-many")


### er sub

## annotate by ER sub-compartment annotations

nest_df4_ann2<-nest_df4%>%
  left_join(.,organelle_input_er_split, by="Gene.Symbol", relationship="many-to-many")



```



#### coeff by compartment

```{r}
## generate tidy version of linear modeling results
linear_results <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  ##remove redundancy
  distinct()%>%
  group_by(Reference, Gene.Symbol, Annotation)%>%
  pivot_longer(cols = 4:11,
               names_to = c("val_type","condition"),
               names_sep = "_")%>%
  group_by(Reference, Gene.Symbol, Annotation)%>%
  pivot_wider( 
            names_from = val_type, 
            values_from = value)%>%
  left_join(.,organelle_input_er_split, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(sig = if_else(q.value < 0.05,if_else(coeff > 0 , "up","down"),"n.s."))%>%
  mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "))


linear_results$condition <- factor(linear_results$condition,levels= c("FAM134AC","FAM134ABC" , "FAM134ABCTEX","FAM134ABCTEXCCPG1"))
##list of up and down regulated betas
up_down<-linear_results%>%filter( q.value < 0.05 )

## filter for organellar info only and plot Beta differences across organelles
violin_betas<-ggplot(linear_results %>%filter(Compartment_ss %in% c("Golgi","Lysosome","Mitochondria","Plasma Membrane","Endosome","Peroxisome",
                                                     "Nucleus","Cytosol","ER" )), aes(condition,coeff,fill=condition))+
  geom_violin(draw_quantiles = c(0.25,.5,.75),alpha=0.8)+
  facet_wrap(.~Compartment_ss)+ylim(c(-1,1))+theme_classic()+
  scale_fill_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  geom_hline(yintercept = 0,linetype="dashed")+
  labs(y=bquote(""~beta[KO]~": Log2FC(additive KO)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))
violin_betas

# ggsave(plot = violin_betas, filename = file.path(baseDir, "figures/ExtDataFig8f_KO_accum_AllOrganelles_violin_LinearModelBetas.pdf", height = 12,width=14))

## ER only
er_violin_betas<-ggplot(linear_results %>%filter(Compartment_ss %in% c("ER","ER Membrane", "ER Lumen", "ER Membrane associated" )), aes("",coeff,fill=condition,color=condition))+
  geom_violin(draw_quantiles = c(0.25,.5,.75),alpha=0.8,color="black")+
  facet_wrap(.~Compartment_ss,nrow=1)+ylim(c(-1,1))+theme_classic()+
  geom_point(position=position_jitterdodge(dodge.width = 0.9),size=0.75,alpha=0.25)+
  geom_hline(yintercept = 0,linetype="dashed")+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  scale_fill_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  scale_color_manual(values = c("#5ec962","#21918c","#3b528b","#440154"))+
  guides(fill = guide_legend(nrow = 1))+
  labs(y=bquote(""~beta[KO]~": Log2FC(additive KO)"))
  

er_violin_betas
# ggsave(plot = er_violin_betas, filename = file.path(baseDir, "figures/Fig4f_KO_accum_ERonly_violin_LinearModelBetas.pdf", height = 6,width=12))

```



#### heatmap ER high curve Accum

heat map of only high curvature and high sheet normalized to mean wt value


```{r}
### same as above but with ATG12
norm_d12_plex2<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

norm_d12_plex2<-norm_d12_plex2%>%
  mutate(sample = str_remove(sample,"d12"))

norm_d12_plex2$sample <- factor(norm_d12_plex2$sample,
                                levels = c("WT_1","WT_2","WT_3",
                                           "ATG12_1","ATG12_2","ATG12_3",
                                           "CA_1","CA_2","CA_3",
                                           "CAB_1","CAB_2","CAB_3",
                                           "CABTEX_1","CABTEX_2","CABTEX_3",
                                           "CABTEXCCPG1_1","CABTEXCCPG1_2","CABTEXCCPG1_3"))


high$Compartment_ss <- factor(high$Compartment_ss, levels = c("ER.high.curvature","ER.high.sheet","ER.Receptors" ))
##extract the FC data for ER KO accumulators
er_raw_accum<-norm_d12_plex2%>%
  inner_join(.,high,by="Gene.Symbol")%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n(),
         Compartment=Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation,-Compartment)%>%
  group_by(ProtID, Compartment_ss)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  arrange(Compartment_ss)%>%
  mutate(Compartment_ss =str_replace_all(Compartment_ss,"\\."," "))

all_dataB_heatmap2 <- er_raw_accum %>%
  ungroup()%>%
  select(-Compartment_ss)%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-er_raw_accum %>%
  select(ProtID, Compartment_ss)

df_col_ann2 <- data.frame("sample"= colnames(er_raw_accum)[3:20], values = c("WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           "CA","CA","CA",
                                           "CAB","CAB","CAB",
                                           "CABTEX","CABTEX","CABTEX",
                                           "CABTEXCCPG1","CABTEXCCPG1","CABTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB2$ProtID, Annotation=annotation_allB2$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap2)

test<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation_row = annoB,annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = file.path(baseDir, "figures/Fig5c_Accum_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5))

```


#### heatmap Luminal ER

heat map of only lumenal normalized to mean wt value


```{r}
## generate rank list for betas to translate to the Log2FC data
luminal_rank_list<-nest_df4_ann2%>%
  select(Reference,Gene.Symbol,Annotation,coeff_FAM134ABCTEXCCPG1,Compartment_ss)%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation,-coeff_FAM134ABCTEXCCPG1,-Compartment_ss)
### Log2FC ATG12 and Penta KO data for lumenal
er_raw_accum_lumen<-norm_d12_plex2%>%
  group_by(Gene.Symbol)%>%
  mutate(counts=n())%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  select(-type,-desc)%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-log2_int,-cellLine,-mean_wt0, -counts,-Annotation)%>%
  group_by(ProtID)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  inner_join(.,luminal_rank_list,by="ProtID")%>%
  arrange(Rank)%>%
  select(-Rank)%>%
  select(1,5:7,17:19)

all_dataB_heatmap2 <- er_raw_accum_lumen %>%
  ungroup()%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-er_raw_accum_lumen %>%
  select(ProtID)

df_col_ann2 <- data.frame("sample"= colnames(er_raw_accum_lumen)[2:7], values = c(
  # "WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           # "CA","CA","CA",
                                           # "CAB","CAB","CAB",
                                           # "CABTEX","CABTEX","CABTEX",
                                           "CABTEXCCPG1","CABTEXCCPG1","CABTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB2$ProtID)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)


annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap2)

## generate heatmap lumenal ordered by top ranking betas
test<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)

# ggsave(plot = test, filename = file.path(baseDir, "figures/ExtDataFig9e_Accum_heatmap_ERhc_ERhs.pdf", height = 4.5,width=7.5))

```


#### Luminal Coef 


```{r}
### heat map only of betas
luminal_rank_list2<-nest_df4_ann2%>%
  select(Reference,Gene.Symbol,Annotation,coeff_FAM134ABCTEXCCPG1,Compartment_ss)%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation,-Compartment_ss,-Rank)


all_dataB_heatmap4 <- luminal_rank_list2 %>%
  ungroup()%>%
  column_to_rownames(var="ProtID")


library(RColorBrewer)


paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-1, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 1, length.out=floor(paletteLength/2)))


# test<-pheatmap(all_dataB_heatmap4, cluster_cols = F, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


```

#### Combine beta and fold change for lumen ER


```{r}
luminal_input<-left_join(er_raw_accum_lumen,luminal_rank_list2,by ="ProtID")


all_dataB_heatmap7 <- luminal_input %>%
  rename(CCPG1_1 = CABTEXCCPG1_1,
         CCPG1_2 = CABTEXCCPG1_2,
         CCPG1_3 = CABTEXCCPG1_3,
         Beta_PKO = coeff_FAM134ABCTEXCCPG1
         )%>%
  ungroup()%>%
  column_to_rownames(var="ProtID")

df_col_ann7 <- data.frame("sample"= colnames(luminal_input)[2:8], values = c(
  # "WT","WT","WT",
                                           "ATG12","ATG12","ATG12",
                                           # "CA","CA","CA",
                                           # "CAB","CAB","CAB",
                                           # "CABTEX","CABTEX","CABTEX",
                                           "CCPG1","CCPG1","CCPG1",
                                           "Beta CCPG1"))

library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann7$sample, Condition=df_col_ann7$values)

annoD$Condition <- factor(annoD$Condition, levels=c("ATG12","CCPG1","Beta CCPG1"))

paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-.75, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, .75, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap7)

test<-pheatmap(all_dataB_heatmap7, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)


# ggsave(plot = test, filename = file.path(baseDir, "figures/ExtDataFig9e_ccpg1_heatmap_ERlumen.pdf", height = 13,width=4.5))
```

#### Export data

```{r}
accum_df_full<-full_join(d12_plexa,nest_df4,by=c("Reference","Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_simple,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()

accum_df_full_erOnly<-full_join(d12_plexa,nest_df4,by=c("Reference","Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


# write.csv(accum_df_full_erOnly, file.path(baseDir, "output/SuppData_accumKO_erOnly.csv"))
# 
# write.csv(accum_df_full, file.path(baseDir, "output/SuppData_accumKO_allData.csv"))

```


#### heatmap singles for Luminal ER

heat map of only high curvature and high sheet normalized to mean wt value


```{r}

## extract ccpg1 fold change data for the lumen proteins to WT
singles_norm_annot<-singles_norm%>%
  select(Reference,Gene.Symbol,Annotation,sample,log2_int_wtd0_norm)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  spread(sample,log2_int_wtd0_norm)%>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol",relationship="many-to-many")%>%
  filter(Compartment_ss == "ER.Lumen")%>%
  select(-Compartment_ss)%>%
  separate(Reference, into=c("type","accession","desc"),sep="\\|")%>%
  unite("ProtID", c(Gene.Symbol,accession),sep="_")%>%
  ungroup()%>%
  select(-type,-desc,-Annotation)%>%
  inner_join(.,luminal_rank_list,by="ProtID")%>%
  arrange(Rank)%>%
  select(-Rank)%>%
  select(1,8:10)




all_dataB_heatmap2 <- singles_norm_annot %>%
  ungroup()%>%
  column_to_rownames(var="ProtID")

annotation_allB2<-singles_norm_annot %>%
  select(ProtID)

df_col_ann2 <- data.frame("sample"= colnames(singles_norm_annot)[2:4], values = c(
                                                    "CCPG1_1","CCPG1_2","CCPG1_3"
                                                                                   ))

annoB<-data.frame(row.names=annotation_allB2$ProtID)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann2$sample, Condition=df_col_ann2$values)%>%
  mutate(Condition = str_sub(Condition,1,-3))

annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-.75, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, .75, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap2)

test2<-pheatmap(all_dataB_heatmap2, cluster_cols = F,  annotation = annoD, color=myColor, breaks=myBreaks, border_color = FALSE,cluster_rows = F)



# ggsave(test2, filename = file.path(baseDir, "figures/ExtDataFig9e_ccpg1_heatmap_ERlumen_singles.pdf", height = 13,width=3.5))

```



### Rank plots 

#### Top25 sub-ER breakdown (All, AC, Penta)

```{r}
high_curve_proteins <- organelle_input_er_split%>%
  filter(Compartment_ss == "ER.high.curvature")

## determine ranks based on penta
er_ac<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  arrange(desc(coeff_FAM134AC))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))


er_ac$Compartment_ss <- factor(er_ac$Compartment_ss, levels = c("ER.Lumen","ER.high.curvature","ER.Membrane","ER.Membrane.associated"))


## determine ranks based on penta
er_ac2<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A")%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))

er_ac2$Compartment_ss <- factor(er_ac2$Compartment_ss, levels = c("ER.Lumen","ER.high.curvature","ER.Membrane","ER.Membrane.associated"))

## determine top beta changing ER proteins for Penta KO
top25_penta<-er_ac2%>%filter(Rank < 26)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

## Determine counts and sub-compartment breakdown from top 25 Penta
penta_bar<-er_ac2%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())%>%
  left_join(.,top25_penta,by="Compartment_ss",suffix=c("_All","_Penta KO"))%>%
  gather("count_type","counts",2:3)%>%
  mutate(counts = replace_na(counts,0))%>%
  mutate(count_type= str_remove(count_type,"counts_"))%>%
  ungroup()%>%
  group_by(count_type)%>%
  mutate(sum_count=sum(counts))


## determine top beta changing ER proteins for AC KO
top25_ac<-er_ac%>%
  filter(Rank < 26)%>%
  group_by(Compartment_ss)%>%
  summarise(counts=n())

## Determine counts and sub-compartment breakdown from top 25 AC append penta too 
ac_bar<-er_ac%>%
  ## determine whole ER break down counts
  group_by(Compartment_ss)%>%
  summarise(counts=n())%>%
  ##append AC changers based on compartment
  left_join(.,top25_ac,by="Compartment_ss",suffix=c("_All","_AC KO"))%>%
  gather("count_type","counts",2:3)%>%
  mutate(count_type= str_remove(count_type,"counts_"))%>%
  ungroup()%>%
  group_by(count_type)%>%
  mutate(sum_count=sum(counts))%>%
  ##bind penta data top25 rows as well
  bind_rows(penta_bar)%>%
  distinct()%>%
  mutate(count_type = if_else(count_type=="All","All",paste("top25 \n",count_type,sep="")))


### plot bar plot of sub-ER class break down among top AC and Penta
percentage_plot<-ggplot(ac_bar,aes(count_type,counts/sum_count*100,fill=Compartment_ss))+
  geom_bar(stat="identity")+
  scale_fill_viridis_d(end=0.8,direction=-1)+
  theme_classic()+
  theme(legend.position = "top",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16),
        legend.text = element_text(size=6))+
  labs(x="",y="Percentage by \n Sub-ER Compartment",fill="")

percentage_plot
# ggsave(percentage_plot, file=file.path(baseDir, "figures/Fig4h_subER_percentTop25.pdf", height=5,width=4 ))
```

#### Fig5a: heatmap top25/bottom5 atg12FC,BetaAC,BetaPenta

Extract top25 and bottom 5

```{r}
### Based on beta/log2FC for AC KO
er_ac_heat<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  arrange(desc(coeff_FAM134AC))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))


er_ac_heat_rankatg12<-er_ac_heat%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  rownames_to_column("Rank_atg12")%>%
  mutate(Rank_atg12 = as.numeric(as.character(Rank_atg12)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat_rankatg12$Compartment_ss <- factor(er_ac_heat_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))


p5b<-ggplot()+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=Rank,y=6,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_viridis_d(end=0.8,direction=-1)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)
p5b


### Based on beta for Penta KO

er_ac_heat2<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  arrange(desc(coeff_FAM134ABCTEXCCPG1))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))

er_ac_heat2_rankatg12<-er_ac_heat2%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  rownames_to_column("Rank_atg12")%>%
  mutate(Rank_atg12 = as.numeric(as.character(Rank_atg12)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat2_rankatg12$Compartment_ss <- factor(er_ac_heat2_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))

p5c<-ggplot()+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat2_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=Rank,y=3,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_manual(values=c("#5DC863FF", "#3B528BFF","#440154FF"))+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat2_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)
p5c


### Based on log2FC for ATG12 KO

er_ac_heat3_rankatg12<-nest_df4_ann2%>%
  dplyr::filter(Compartment_ss %in% c("ER.Membrane","ER.Lumen","ER.Membrane.associated","ER.high.curvature") , Gene.Symbol != "FAM134A" )%>%
  left_join(.,d12_plexa,by=c("Reference","Gene.Symbol","Annotation"))%>%
  arrange(desc(log2FC_ATG12d12.WTd12))%>%
  tibble::rownames_to_column("Rank")%>%
  mutate(Rank = as.numeric(as.character(Rank)))%>%
  filter(Rank<26|Rank>262)%>%
  mutate(Rank3 = paste("(",Rank,")",sep=""))%>%
  mutate(Rank = if_else(Rank >25, Rank-236,Rank))%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss , "\\."," "))

er_ac_heat3_rankatg12$Compartment_ss <- factor(er_ac_heat3_rankatg12$Compartment_ss, levels = c("ER Lumen","ER high curvature","ER Membrane","ER Membrane associated"))




p5d<-ggplot()+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,3,fill=coeff_FAM134ABCTEXCCPG1))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,4,fill=coeff_FAM134ABCTEX))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,5,fill=coeff_FAM134ABC))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,2,fill=log2FC_CABTEXCCPG1d12.WTd12))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,6,fill=coeff_FAM134AC))+
  geom_tile(data=er_ac_heat3_rankatg12, aes(Rank,1,fill=log2FC_ATG12d12.WTd12))+
  scale_fill_gradient2(low="#542788",high="#B35806",midpoint = 0,mid = "grey95")+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=Rank,y=7.45,label=Gene.Symbol, color=Compartment_ss),size=4,angle=90)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=Rank,y=1,label=Rank3),size=4,angle=90)+
  ylim(c(0.5,8))+xlim(c(-2.5,32.5))+
  theme_classic()+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank(),
        legend.title = element_blank())+
  scale_color_viridis_d(end=0.8,direction=-1)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=3,label="Beta PKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=4,label="Beta QKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=5,label="Beta TKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=6,label="Beta DKO"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=2,label="Penta-WT"),size=4)+
  geom_text(data=er_ac_heat3_rankatg12, aes(x=-2,y=1,label="ATG12-WT"),size=4)

p5d


# ggsave(p5b,file=file.path(baseDir, "figures/Fig5a_DKOtop25_heatmap.pdf",width=10,height=4))
# 
# ggsave(p5c,file=file.path(baseDir, "figures/Fig5a_PKOtop25_heatmap.pdf",width=10,height=4))
# 
# ggsave(p5d,file=file.path(baseDir, "figures/Fig5a_ATG12top25_heatmap.pdf",width=10,height=4))
```


### Beta based heat map for coefficients


```{r}
high$Compartment_ss <- factor(high$Compartment_ss, levels=c("ER.high.curvature", "ER.high.sheet",     "ER.Receptors"))
### extract beta for shaping proteins and receptors
heatmap_coef_highcurve <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  rename(FAM134AC = coeff_FAM134AC,
         FAM134ABC = coeff_FAM134ABC,
         FAM134ABCTEX = coeff_FAM134ABCTEX,
         FAM134ABCTEXCCPG1 = coeff_FAM134ABCTEXCCPG1)%>%
  distinct()%>%
  separate(Reference, into= c("type","Reference","nameextra"),sep="\\|")%>%
  select(-type,-nameextra)%>%
  inner_join(.,high, by="Gene.Symbol")%>%
  mutate(
    # Compartment_ss=str_replace_all(Compartment_ss,"\\."," "),
         Gene = paste(Gene.Symbol,Reference,sep="_"),
         ProtID = Gene)%>%
  ungroup()%>%
  select(-Annotation, -Reference, -Gene.Symbol)%>%
  select(ProtID,FAM134AC, FAM134ABC,FAM134ABCTEX,FAM134ABCTEXCCPG1,
         Compartment_ss,Gene)%>%
  arrange(Compartment_ss,ProtID)

# heatmap_coef_highcurve$Compartment_ss <- factor(heatmap_coef_highcurve$Compartment_ss, levels=c("ER.high.curvature", "ER.high.sheet",     "ER.Receptors"))

heatmap_coef_highcurve<-heatmap_coef_highcurve%>%
  arrange(Compartment_ss,ProtID)


all_dataB_heatmap3 <- heatmap_coef_highcurve %>%
  ungroup()%>%
  select(-Compartment_ss, -Gene)%>%
  column_to_rownames(var="ProtID")

annotation_allB3<-heatmap_coef_highcurve %>%
  select(ProtID, Compartment_ss)

df_col_ann3 <- data.frame("sample"= colnames(heatmap_coef_highcurve)[2:5], values = c("FAM134AC","FAM134ABC","FAM134ABCTEX","FAM134ABCTEXCCPG1"))

annoB<-data.frame(row.names=annotation_allB3$ProtID, Annotation=annotation_allB3$Compartment_ss)
library(RColorBrewer)

annoD<-data.frame(row.names=df_col_ann3$sample, Condition=df_col_ann3$values)

# creat colours for each group
newCols <- colorRampPalette(grDevices::rainbow(length(unique(annoB$Annotation))))
annoCol <- newCols(length(unique(annoB$Annotation)))
names(annoCol) <- unique(annoB$Annotation)
annoCol <- list(category = annoCol)
paletteLength <- 50
myColor <- colorRampPalette(c("#542788", "grey95", "#B35806"))(paletteLength)
myBreaks <- c(seq(-0.5, 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(4/paletteLength, 0.5, length.out=floor(paletteLength/2)))

rownames(annoD) <- colnames(all_dataB_heatmap3)

test<-pheatmap(all_dataB_heatmap3, cluster_cols = F,  annotation_row = annoB,color=myColor, breaks=myBreaks, border_color = FALSE,annotation = annoD,cluster_rows = F)


# ggsave(plot = test, filename = file.path(baseDir, "figures/Fig5c_Accum_heatmap_ERhc_ERhs_LinearModelBetas.pdf", height = 4.5,width=5))

```



#### Point Plot ATG12 vs KO FC


```{r}
### Log2FC AC KO - WT vs ATG12 KO - WT
### extra based on all proteins by compartment
accum_fc2_CA<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CA = median(log2FC_CAd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CA= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CA,yend=med_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CA,yend=q3_CA,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CA,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Log2(DKO/WT)",x="Log2(ATG12-WT)")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")

### Log2FC ABC KO - WT vs ATG12 KO - WT

accum_fc2_CAB<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CAB = median(log2FC_CABd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CAB= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB= quantile(log2FC_CABd12.WTd12,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Log2(TKO/WT)",x="Log2(ATG12-WT)")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")


### Log2FC ABC/TEX KO - WT vs ATG12 KO - WT

accum_fc2_CABTEX<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEX = median(log2FC_CABTEXd12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_CABTEX= quantile(log2FC_CABTEXd12.WTd12,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Log2(QKO/WT)",x="Log2(ATG12-WT)")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")




### Log2FC ABC/TEX/CCPG1 KO - WT vs ATG12 KO - WT

accum_fc2_CABTEXCCPG1<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(log2FC_CABTEXCCPG1d12.WTd12),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_CABTEXCCPG1= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Log2(PKO/WT)",x="Log2(ATG12-WT)")+
  ylim(c(-.2,.45))+geom_abline(slope = 1,linetype="dashed")

plot_fc_accum_point<-plot_grid(p1,p2,p3,p4,nrow=1)

plot_fc_accum_point

# ggsave(plot = plot_fc_accum_point, filename = file.path(baseDir, "figures/ExtDataFig6d_point_plot_fc_toATG12.pdf", height = 6,width=20))


plot_fc_accum_point<-plot_grid(p1,p4,nrow=2)

plot_fc_accum_point

# ggsave(plot = plot_fc_accum_point, filename = file.path(baseDir, "figures/Fig4c_point_plot_fc_toATG12.pdf", height = 12,width=6))

```



#### Accum KO Coeff based Point plot

Plot correlation plot for Beta information based on sub-cellular compartment.

```{r}
accum_fc2_all<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))


linear_results_all <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()



accum_fc2_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CAB=median(coeff_FAM134ABC),
            med_CA = median(coeff_FAM134AC),
            q1_CAB= quantile(coeff_FAM134ABC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[DKO_TKO]~""),x=bquote(""~beta[WT_DKO]~""))+
  ylim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")+
  scale_x_continuous(limits=c(-.25,.4), breaks = c(-.2,-.1,0,.1,.2,.3,.4))

  p1

### CAB

accum_fc2_CAB_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEX=median(coeff_FAM134ABCTEX),
            med_CAB = median(coeff_FAM134ABC),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX,0.75),
            q1_CAB= quantile(coeff_FAM134ABC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CAB,xend=q3_CAB,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CAB,xend=med_CAB,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[TKO_QKO]~""),x=bquote(""~beta[DKO_TKO]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")


 # p2
### CAB TEX

accum_fc2_CABTEX_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1),
            med_CABTEX = median(coeff_FAM134ABCTEX),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CABTEX,xend=q3_CABTEX,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CABTEX,xend=med_CABTEX,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[QKO_PKO]~""),x=bquote(""~beta[TKO_QKO]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.25))+geom_abline(slope = 1,linetype="dashed")

p3

### CAB TEX

accum_fc2_CABTEXCCPG1_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(coeff_FAM134ABCTEXCCPG1),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 ,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX CCPG1 KO Coef - WT",x="ATG12 KO - WT")+
  ylim(c(-.3,.45))+
  xlim(c(-.3,.65))+geom_abline(slope = 1,linetype="dashed")
  

# plot_accum_fc <- plot_grid(p1,p2,p3,p4,nrow=1, rel_widths = c(1,1,1,1.5))

plot_accum_fc <- plot_grid(p1,p2,p3,nrow=1, rel_widths = c(1.3,1,1))

plot_accum_fc


# ggsave(plot = plot_accum_fc, filename = file.path(baseDir, "figures/ExtDataFig8a_point_plot_coef_accum_compare.pdf", height = 5.1,width=18))


```


#### AC vs penta beta point plot

```{r}
accum_fc2_CABTEX_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1),
            med_CA = median(coeff_FAM134AC),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA=  quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p4h<-ggplot(accum_fc2_CABTEX_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[QKO_PKO]~""),x=bquote(""~beta[WT_DKO]~""))+
  ylim(c(-.25,.25))+
  xlim(c(-.25,.4))+geom_abline(slope = 1,linetype="dashed")

p4h

# ggsave(plot = p4h, filename = file.path(baseDir, "figures/Fig4g_point_plot_AC_penta_betas.pdf", height = 5.1,width=7.14))
```



#### stats localization for changing betas

t-test by localization for each of the betas 

```{r}
linear_results_all_stats <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1)%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()%>%
  group_by(Compartment_ss)%>%
  nest()%>%
  mutate(Compartment_ss = if_else(is.na(Compartment_ss), "Unannotated",Compartment_ss))

ttest_enrich<- function(data){
  df <- data.frame(data)
  # print("one")
  t_ac <- t.test(df$coeff_FAM134AC, mu = 0)
  t_abc <- t.test(df$coeff_FAM134ABC, mu = 0)
  t_abct <- t.test(df$coeff_FAM134ABCTEX, mu = 0)
  t_abctc <- t.test(df$coeff_FAM134ABCTEXCCPG1, mu = 0)

  p.val_AC <- t_ac$p.value
  p.val_ABC <- t_abc$p.value
  p.val_ABCTEX <- t_abct$p.value
  p.val_ABCTEXCCPG1 <- t_abctc$p.value

  FC_AC <- t_ac$estimate[[1]]
  FC_ABC <- t_abc$estimate[[1]]
  FC_ABCTEX <- t_abct$estimate[[1]]
  FC_ABCTEXCCPG1 <- t_abctc$estimate[[1]]

  df2<-data.frame(
    "FC_AC" = FC_AC,
    "FC_ABC" = FC_ABC,
    "FC_ABCTEX" = FC_ABCTEX,
    "FC_ABCTEXCCPG1"= FC_ABCTEXCCPG1,
    "p.val_AC" = p.val_AC,
    "p.val_ABC" = p.val_ABC,
    "p.val_ABCTEX" = p.val_ABCTEX,
    "p.val_ABCTEXCCPG1" = p.val_ABCTEXCCPG1
  )
  return(df2)
}

linear_results_all_stats2<-linear_results_all_stats%>%
  mutate(df_stats = data %>% map(ttest_enrich))%>%
  unnest(df_stats)

linear_results_all_stats2$q.val_AC <- p.adjust(linear_results_all_stats2$p.val_AC,method="bonferroni")
linear_results_all_stats2$q.val_ABC <- p.adjust(linear_results_all_stats2$p.val_ABC,method="bonferroni")
linear_results_all_stats2$q.val_ABCTEX <- p.adjust(linear_results_all_stats2$p.val_ABCTEX,method="bonferroni")
linear_results_all_stats2$q.val_ABCTEXCCPG1 <- p.adjust(linear_results_all_stats2$p.val_ABCTEXCCPG1,method="bonferroni")
```



#### REMOVE DO NOT USE Accum KO Coeff based Additive 

this is equivalent to the fold changes


```{r}
accum_fc2_all<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))


linear_results_all <- nest_df4_ann2%>%
  select(Reference, Gene.Symbol, Annotation, coeff_FAM134AC, coeff_FAM134ABC,coeff_FAM134ABCTEX,coeff_FAM134ABCTEXCCPG1, q.value_FAM134AC,q.value_FAM134ABC,q.value_FAM134ABCTEX,q.value_FAM134ABCTEXCCPG1)%>%
  left_join(.,accum_fc2_all,by = c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  distinct()



accum_fc2_CA_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CAB=median(coeff_FAM134ABC+coeff_FAM134AC),
            med_CA = median(coeff_FAM134AC),
            q1_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CA= quantile(coeff_FAM134AC,0.25),
            q3_CA= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p1<-ggplot(accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CA,xend=q3_CA,y=med_CAB,yend=med_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CA,xend=med_CA,y=q1_CAB,yend=q3_CAB,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CA_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CA,med_CAB,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="CAB KO - WT",x="CA KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")
p1

### CAB

accum_fc2_CAB_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEX=median(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            med_CAB = median(coeff_FAM134ABC+coeff_FAM134AC),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CAB= quantile(coeff_FAM134ABC+coeff_FAM134AC,0.75),
            num_proteins = n())

p2<-ggplot(accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CAB,xend=q3_CAB,y=med_CABTEX,yend=med_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CAB,xend=med_CAB,y=q1_CABTEX,yend=q3_CABTEX,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CAB_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CAB,med_CABTEX,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX KO Coeff - WT",x="CAB KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")


p2
### CAB TEX

accum_fc2_CABTEX_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CABTEXCCPG1=median(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            med_CABTEX = median(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1+coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            q1_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.25),
            q3_CABTEX= quantile(coeff_FAM134ABCTEX+coeff_FAM134ABC+coeff_FAM134AC,0.75),
            num_proteins = n())

p3<-ggplot(accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CABTEX,xend=q3_CABTEX,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CABTEX,xend=med_CABTEX,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEX_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CABTEX,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.2,.4))+
  xlim(c(-.2,.4))+
  geom_abline(slope = 1,linetype="dashed")

p3

### CAB TEX

accum_fc2_CABTEXCCPG1_coeff<-linear_results_all%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(log2FC_ATG12d12.WTd12),
            med_CABTEXCCPG1 = median(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX),
            q1_atg12= quantile(log2FC_ATG12d12.WTd12,0.25),
            q3_atg12= quantile(log2FC_ATG12d12.WTd12,0.75),
            q1_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX,0.25),
            q3_CABTEXCCPG1= quantile(coeff_FAM134ABCTEXCCPG1 + coeff_FAM134AC + coeff_FAM134ABC + coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p4<-ggplot(accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_CABTEXCCPG1,yend=med_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_CABTEXCCPG1,yend=q3_CABTEXCCPG1,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=accum_fc2_CABTEXCCPG1_coeff%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_atg12,med_CABTEXCCPG1,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="ABC TEX CCPG1 KO Coeff - WT",x="ATG12 KO - WT")+
  ylim(c(-.3,.45))+
  xlim(c(-.3,.65))
  

plot_grid(p1,p2,p3,p4,nrow=1)
```



## Combine the singlet and accum

```{r}

singles_final <- singles%>%
  select(Reference,Gene.Symbol,Annotation,
         log2FC_ATG12.WT,log2FC_CCPG1.WT,log2FC_TEX264.WT,
         log2FC_FAM134A.WT,log2FC_FAM134B.WT,log2FC_FAM134C.WT,
         q.val_ATG12.WT,q.val_CCPG1.WT,q.val_TEX264.WT,
         q.val_FAM134A.WT,q.val_FAM134B.WT,q.val_FAM134C.WT)%>%
  distinct()

fc_accum<-d12_plexa%>%
  select(Reference, Gene.Symbol,Annotation,
         log2FC_ATG12d12.WTd12,log2FC_CAd12.WTd12,log2FC_CABd12.WTd12,log2FC_CABTEXd12.WTd12,
         log2FC_CABTEXCCPG1d12.WTd12,
         q.val_ATG12d12.WTd12,q.val_CAd12.WTd12,q.val_CABd12.WTd12,q.val_CABTEXd12.WTd12,
         q.val_CABTEXCCPG1d12.WTd12)%>%
  distinct()
  

accum_final_df<-left_join(nest_df4, fc_accum,by=c("Reference", "Gene.Symbol","Annotation"))

singles_accum <- inner_join(accum_final_df, singles_final,by=c("Reference", "Gene.Symbol","Annotation"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")


```


### CA

```{r}

### CA to C
CA_fc_to_Csing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_C=median(log2FC_FAM134C.WT),
            med_CA_fc = median(log2FC_CAd12.WTd12),
            q1_C= quantile(log2FC_FAM134C.WT,0.25),
            q3_C= quantile(log2FC_FAM134C.WT,0.75),
            q1_CA_fc= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA_fc= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p1<-ggplot(CA_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_C,xend=q3_C,y=med_CA_fc,yend=med_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_C,xend=med_C,y=q1_CA_fc,yend=q3_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(FAM134A/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134C KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")



### A vs CA

### extra based on all proteins by compartment
CA_fc_to_Asing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_A=median(log2FC_FAM134A.WT),
            med_CA_fc = median(log2FC_CAd12.WTd12),
            q1_A= quantile(log2FC_FAM134A.WT,0.25),
            q3_A= quantile(log2FC_FAM134A.WT,0.75),
            q1_CA_fc= quantile(log2FC_CAd12.WTd12,0.25),
            q3_CA_fc= quantile(log2FC_CAd12.WTd12,0.75),
            num_proteins = n())

p3<-ggplot(CA_fc_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_A,xend=q3_A,y=med_CA_fc,yend=med_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_A,xend=med_A,y=q1_CA_fc,yend=q3_CA_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_fc_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(FAM134A/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134A KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")



### A vs CA coeff

### extra based on all proteins by compartment
CA_coef_to_Asing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_A=median(log2FC_FAM134A.WT),
            med_CA_coef = median(coeff_FAM134AC),
            q1_A= quantile(log2FC_FAM134A.WT,0.25),
            q3_A= quantile(log2FC_FAM134A.WT,0.75),
            q1_CA_coef= quantile(coeff_FAM134AC,0.25),
            q3_CA_coef= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p4<-ggplot(CA_coef_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_A,xend=q3_A,y=med_CA_coef,yend=med_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_A,xend=med_A,y=q1_CA_coef,yend=q3_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_coef_to_Asing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_A,med_CA_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[WT_DKO]~""),x=bquote(""~Log[2]~"(FAM134A KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))

### extra based on all proteins by compartment
CA_coef_to_Csing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_C=median(log2FC_FAM134C.WT),
            med_CA_coef = median(coeff_FAM134AC),
            q1_C= quantile(log2FC_FAM134C.WT,0.25),
            q3_C= quantile(log2FC_FAM134C.WT,0.75),
            q1_CA_coef= quantile(coeff_FAM134AC,0.25),
            q3_CA_coef= quantile(coeff_FAM134AC,0.75),
            num_proteins = n())

p2<-ggplot(CA_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_C,xend=q3_C,y=med_CA_coef,yend=med_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_C,xend=med_C,y=q1_CA_coef,yend=q3_CA_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CA_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_C,med_CA_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[WT_DKO]~""),x=bquote(""~Log[2]~"(FAM134C KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))


```


### Triple / CAB

```{r}
### CA to C
CAB_fc_to_Csing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_B=median(log2FC_FAM134B.WT),
            med_CAB_fc = median(log2FC_CABd12.WTd12),
            q1_B= quantile(log2FC_FAM134B.WT,0.25),
            q3_B= quantile(log2FC_FAM134B.WT,0.75),
            q1_CAB_fc= quantile(log2FC_CABd12.WTd12,0.25),
            q3_CAB_fc= quantile(log2FC_CABd12.WTd12,0.75),
            num_proteins = n())

p5<-ggplot(CAB_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_B,xend=q3_B,y=med_CAB_fc,yend=med_CAB_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_B,xend=med_B,y=q1_CAB_fc,yend=q3_CAB_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CAB_fc_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(FAM134A/B/C KO - WT)"),x=bquote(""~Log[2]~"(FAM134B KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))


### CA to C
CAB_coef_to_Csing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_B=median(log2FC_FAM134B.WT),
            med_CAB_coef = median(coeff_FAM134ABC),
            q1_B= quantile(log2FC_FAM134B.WT,0.25),
            q3_B= quantile(log2FC_FAM134B.WT,0.75),
            q1_CAB_coef= quantile(coeff_FAM134ABC,0.25),
            q3_CAB_coef= quantile(coeff_FAM134ABC,0.75),
            num_proteins = n())

p6<-ggplot(CAB_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_B,xend=q3_B,y=med_CAB_coef,yend=med_CAB_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_B,xend=med_B,y=q1_CAB_coef,yend=q3_CAB_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=CAB_coef_to_Csing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_B,med_CAB_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[DKO_TKO]~""),x=bquote(""~Log[2]~"(FAM134B KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))

```


### Quad/TEX264

```{r}
quad_coef_to_TEXsing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_TEX=median(log2FC_TEX264.WT),
            med_quad_coef = median(coeff_FAM134ABCTEX),
            q1_TEX= quantile(log2FC_TEX264.WT,0.25),
            q3_TEX= quantile(log2FC_TEX264.WT,0.75),
            q1_quad_coef= quantile(coeff_FAM134ABCTEX,0.25),
            q3_quad_coef= quantile(coeff_FAM134ABCTEX,0.75),
            num_proteins = n())

p8<-ggplot(quad_coef_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_TEX,xend=q3_TEX,y=med_quad_coef,yend=med_quad_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_TEX,xend=med_TEX,y=q1_quad_coef,yend=q3_quad_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=quad_coef_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[TKO_QKO]~""),x=bquote(""~Log[2]~"(TEX264 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))


####

quad_fc_to_TEXsing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_TEX=median(log2FC_TEX264.WT),
            med_quad_fc = median(log2FC_CABTEXd12.WTd12),
            q1_TEX= quantile(log2FC_TEX264.WT,0.25),
            q3_TEX= quantile(log2FC_TEX264.WT,0.75),
            q1_quad_fc= quantile(log2FC_CABTEXd12.WTd12,0.25),
            q3_quad_fc= quantile(log2FC_CABTEXd12.WTd12,0.75),
            num_proteins = n())

p7<-ggplot(quad_fc_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_TEX,xend=q3_TEX,y=med_quad_fc,yend=med_quad_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_TEX,xend=med_TEX,y=q1_quad_fc,yend=q3_quad_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=quad_fc_to_TEXsing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_TEX,med_quad_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(Quad KO - WT)"),x=bquote(""~Log[2]~"(TEX264 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))
```




### Penta


```{r}

### CCPG1 coeff
penta_coef_to_CCPG1sing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CCPG1=median(log2FC_CCPG1.WT),
            med_penta_coef = median(coeff_FAM134ABCTEXCCPG1),
            q1_CCPG1= quantile(log2FC_CCPG1.WT,0.25),
            q3_CCPG1= quantile(log2FC_CCPG1.WT,0.75),
            q1_penta_coef= quantile(coeff_FAM134ABCTEXCCPG1,0.25),
            q3_penta_coef= quantile(coeff_FAM134ABCTEXCCPG1,0.75),
            num_proteins = n())

p10<-ggplot(penta_coef_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_coef,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CCPG1,xend=q3_CCPG1,y=med_penta_coef,yend=med_penta_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CCPG1,xend=med_CCPG1,y=q1_penta_coef,yend=q3_penta_coef,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=penta_coef_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_coef,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~beta[QKO_PKO]~""),x=bquote(""~Log[2]~"(CCPG1 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,.35))+
  ylim(c(-0.25,0.5))




p10

### CCPG1 FC


penta_fc_to_CCPG1sing<-singles_accum%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_CCPG1=median(log2FC_CCPG1.WT),
            med_penta_fc = median(log2FC_CABTEXCCPG1d12.WTd12),
            q1_CCPG1= quantile(log2FC_CCPG1.WT,0.25),
            q3_CCPG1= quantile(log2FC_CCPG1.WT,0.75),
            q1_penta_fc= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.25),
            q3_penta_fc= quantile(log2FC_CABTEXCCPG1d12.WTd12,0.75),
            num_proteins = n())

p9<-ggplot(penta_fc_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_fc,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_CCPG1,xend=q3_CCPG1,y=med_penta_fc,yend=med_penta_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_CCPG1,xend=med_CCPG1,y=q1_penta_fc,yend=q3_penta_fc,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=penta_fc_to_CCPG1sing%>%filter(Compartment_ss %!in% c("Cis Golgi","Trans Golgi","ERGIC","ER high sheet","ER high curvature","ER Receptors")),aes(med_CCPG1,med_penta_fc,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y=bquote(""~Log[2]~"(Penta KO - WT)"),x=bquote(""~Log[2]~"(CCPG1 KO - WT)"))+
  geom_abline(slope=1,linetype="dashed")+
  xlim(c(-.4,0.35))+
  ylim(c(-.25,0.5))

p9
```


#### All plots 


```{r}
p21<-plot_grid(p3,p4)
p22<-plot_grid(p1,p2)
p20 <- plot_grid(p4,p2)
p23<-plot_grid(p5,p6)
p24<-plot_grid(p7,p8)
p25<-plot_grid(p9,p10)

supfig4_sing_accum<-plot_grid(p20,p23,p24,p25,nrow=4,ncol=1, align="hv")

supfig4_sing_accum

# ggsave(plot = supfig4_sing_accum, filename = file.path(baseDir, "figures/ExtDataFig8bcde_point_plot_singlets_vs_KOaccum.pdf", height = 20.4,width=10.2))


```


## Individual protein plots: betas and FC

### FAM134A


```{r}
list_proteins <- c("FAM134A")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-3.5,3.5))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-3.5,3.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

FAM134A<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

FAM134A

# ggsave(FAM134A,  filename = file.path(baseDir, "figures/Fig4e_FAM134A.pdf", height = 7,width=6))
```




### REEP1


```{r}
list_proteins <- c("REEP1")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

REEP1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

REEP1

# ggsave(REEP1,  filename = file.path(baseDir, "figures/Fig5e_REEP1.pdf", height = 7,width=6))
```

### REEP3


```{r}
list_proteins <- c("REEP3")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-2,2))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

REEP3<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

REEP3

# ggsave(REEP3,  filename = file.path(baseDir, "figures/Fig5e_REEP3.pdf", height = 7,width=6))
```



### REEP4


```{r}
list_proteins <- c("REEP4")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

REEP4<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

REEP4

# ggsave(REEP4,  filename = file.path(baseDir, "figures/ExtDataFig9b_REEP4.pdf", height = 7,width=6))
```



### REEP5


```{r}
list_proteins <- c("REEP5")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

REEP5<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

REEP5

# ggsave(REEP5,  filename = file.path(baseDir, "figures/ExtDataFig9a_REEP5.pdf", height = 7,width=6))
```




### ATL1


```{r}
list_proteins <- c("ATL1")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

ATL1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

ATL1

# ggsave(ATL1,  filename = file.path(baseDir, "figures/ExtDataFig9a_ATL1.pdf", height = 7,width=6))
```



### VAPA


```{r}
list_proteins <- c("VAPA")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1.5,1.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))

VAPA<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
VAPA

# ggsave(VAPA,  filename = file.path(baseDir, "figures/Fig5f_VAPA.pdf", height = 7,width=6))

```





### VAPB


```{r}

list_proteins <- c("VAPB")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



VAPB<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

VAPB

# ggsave(VAPB,  filename = file.path(baseDir, "figures/ExtDataFig9f_VAPB.pdf", height = 7,width=6))
```


### RTN1-C

```{r}
list_proteins <- c("RTN1")

target_prot_data<-combine_df_complete %>% 
    filter(Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


target_prot_data<-combine_df_complete %>% 
  filter(Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data%>%mutate(Gene.Symbol= "RTN1-C") , aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Reference  ==  "sp|Q16799-3|RTN1_HUMAN")%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



RTN1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

RTN1

# ggsave(RTN1,  filename = file.path(baseDir, "figures/Fig5d_RTN1C.pdf", height = 7,width=6))
```




### RTN3

```{r}

list_proteins <- c("RTN3")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-0.5,0.5))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



RTN3<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
RTN3

# ggsave(RTN3,  filename = file.path(baseDir, "figures/ExtDataFig9a_RTN3.pdf", height = 7,width=6))
```



### P4HA1

```{r}

list_proteins <- c("P4HA1")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



P4HA1<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
P4HA1


# ggsave(P4HA1,  filename = file.path(baseDir, "figures/ExtDataFig9d_P4HA1.pdf", height = 7,width=6))
```

### P4HA2

```{r}
list_proteins <- c("P4HA2")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-1,1))

###

target <-linear_results %>% filter(Compartment_ss == "ER",Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



P4HA2<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))
P4HA2

# ggsave(P4HA2,  filename = file.path(baseDir, "figures/ExtDataFig9d_P4HA2.pdf", height = 7,width=6))
```



### SPAST

```{r}
list_proteins <- c("SPAST")

target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))




target_prot_data<-combine_df_complete %>% 
         filter(Gene.Symbol %in%list_proteins)%>%
  mutate(condition=as.character(samp),
         condition = if_else(condition == "CABTEX","Quad",if_else(condition == "CABTEXCCPG1","Penta",condition)))

target_prot_data$condition <- factor(target_prot_data$condition, levels=c("WT","CA","CAB","Quad","Penta"))


p2<-ggplot(target_prot_data %>% 
         filter(Gene.Symbol %in%list_proteins), aes(condition,log2_int_wtd0_norm,color=samp))+geom_jitter(width=0.15,alpha=0.4,size=3)+theme_classic()+
  facet_wrap(.~Gene.Symbol)+geom_hline(yintercept = 0,linetype="dashed")+scale_color_viridis_d(end=0.8,direction=-1)+
  theme(legend.position = "none",
        axis.title = element_text(size = 18),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        strip.text = element_text(size=16))+
  labs(x="",y=bquote(""~Log[2]~"(KO / UT)"))+
  ylim(c(-.75,.75))

###

target <-linear_results %>% filter(Gene.Symbol %in% list_proteins)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank=as.numeric(as.character(Rank)))

target$name <- c("AC","ABC","Quad","Penta")

p1<-ggplot(target,aes(xmin=Rank-0.25,xmax=Rank+0.25,ymin=0,ymax=0.5, fill=coeff))+
  geom_rect()+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806")+
  theme_classic()+
  geom_point(data=target%>%filter(q.value<0.05),aes(x=Rank,y=0.25),size=5,shape=8,color="lightgreen")+
  labs(y="",x="", fill=bquote(""~beta~""))+
  geom_text(data=target, aes(x=Rank,y=0.65,label=name),size=4)+
  theme(legend.position = "top",
        axis.ticks.x.bottom = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(hjust = 0.25,vjust = 0.75),
        axis.text= element_blank(),
        axis.line = element_blank())

p3<-plot_grid(NA,p1,NA,nrow=1,rel_widths = c(0.26,1,0.15))



SPAST<-plot_grid(p3,p2,nrow=2,rel_heights = c(1,2.2))

SPAST

# ggsave(SPAST,  filename = file.path(baseDir, "figures/ExtDataFig9b_SPAST.pdf", height = 7,width=6))
```


### Fig5 model figure

```{r}

## add annotations for TM number
tm_annotation <- read.csv(file.path(baseDir, "data/ER_proteins_TMannotation.csv")) %>%
  left_join(.,organelle_input_er_split,by="Gene.Symbol")%>%
  filter(Compartment_ss != "ER")%>%
  filter(str_detect(Compartment_ss,"ER." ), Compartment_ss !="ERGIC")
##identify whether significant based on +/- FC and q-value < 0.05
fig5_df<-nest_df4_ann2%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane.associated","ER.Membrane",
                               "ER.Receptors","ER.high.sheet","ER.high.curvature"  ))%>%
  mutate(sig_AC = if_else(q.value_FAM134AC<0.05,if_else(coeff_FAM134AC>0,"up","down"),"n.s."),
         sig_TEX = if_else(q.value_FAM134ABCTEX<0.05,if_else(coeff_FAM134ABCTEX>0,"up","down"),"n.s."),
         sig_CCPG1 = if_else(q.value_FAM134ABCTEXCCPG1<0.05,if_else(coeff_FAM134ABCTEXCCPG1>0,"up","down"),"n.s."))%>%
  filter(sig_AC != "n.s." |  sig_TEX != "n.s." | sig_CCPG1 != "n.s.")%>%
  mutate(group = if_else(sig_AC == "up", if_else(sig_CCPG1 == "up", "AC_up_CCPG1_up", if_else(sig_CCPG1 == "down", "AC_up_CCPG1_down", "AC_up")),
                         if_else(sig_AC == "down", if_else(sig_CCPG1 == "up","AC_down_CCPG1_up",if_else(sig_CCPG1 == "down", "AC_down_CCPG1_down",if_else(sig_TEX == "down","AC_down_TEX_down","AC_down"))),
                                 if_else(sig_AC == "n.s.",
                                         if_else(sig_CCPG1 == "up","CCPG1_up", if_else(sig_CCPG1 == "down", "CCPG1_down", "ERROR")),"ERROR"))))

## rank order in reverse by beta combination type
fig5_df_tm <- left_join(fig5_df%>%select(-Compartment_ss),tm_annotation,by="Gene.Symbol",relationship="many-to-many")%>%
  filter(Compartment_ss != "ER.Receptors")%>%
  distinct()%>%
  group_by(Gene.Symbol)%>%
  mutate(counts_geneSymbol =n())%>%
  arrange(TMval, Compartment_ss,group)%>%
  rownames_to_column("Rank")%>%
  mutate(Rank= as.numeric(as.character(Rank)))%>%
  group_by(TMval, Compartment_ss)%>%
  mutate(rank_val = rank(Rank))%>%
  mutate(ac_plot = if_else(sig_AC != "n.s.",coeff_FAM134AC,-1000),
         tex_plot = if_else(sig_TEX != "n.s.",coeff_FAM134ABCTEX,-1000),
         ccpg1_plot = if_else(sig_CCPG1 != "n.s.",coeff_FAM134ABCTEXCCPG1,-1000))

fig5_df_tm[fig5_df_tm == -1000] <- NA

fig5_df_tm2<-fig5_df_tm

# write.csv(fig5_df_tm , "C:/Harper/Side_analysis/Melissa_shiny/ERphagy/fig5_er_beta_map_info_TMannotation.csv")


###membrane only
fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss == "ER.Membrane")

mem<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))



## lumen only
fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss == "ER.Lumen")

lum<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))


## associated (not lumenal, membrane, or high sheet: others with ER designations)

fig5_df_tm3<-fig5_df_tm2%>%
  filter(Compartment_ss != "ER.Lumen", Compartment_ss != "ER.Membrane" , Compartment_ss != "ER.high.sheet")

rest<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))

## high sheet
fig5_df_tm3<-fig5_df_tm2%>%
  filter( Compartment_ss == "ER.high.sheet")

high_sheet<-ggplot()+
  geom_text(data=fig5_df_tm3%>%distinct(TMval,TMname), aes(TMval+0.25,0.5,label=TMname),size=6)+
  geom_text(data=fig5_df_tm3, aes(TMval-0.1,-rank_val+0.1,color=group,label=Gene.Symbol),size=3)+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28,fill=ac_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43,fill=tex_plot))+
  geom_rect(data=fig5_df_tm3,aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58,fill=ccpg1_plot))+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot>0.75),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#B35806")+
  geom_rect(data=fig5_df_tm3%>%filter(ac_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.15,xmax=TMval+.28),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(tex_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.3,xmax=TMval+0.43),fill="#542788")+
  geom_rect(data=fig5_df_tm3%>%filter(ccpg1_plot<(-0.75)),aes(ymin=-rank_val+0.45,ymax=-rank_val-0.45,xmin=TMval+0.45,xmax=TMval+0.58),fill="#542788")+
  scale_fill_gradient2(low = "#542788",mid = "grey95",midpoint = 0,high = "#B35806",limits=c(-.75,0.75),na.value = "grey90")+xlim(c(-1,11))+
  theme_classic()+
  labs(fill="Beta")+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank())+
  ylim(c(-44,1))


## combine so the dimensions work out
test<-plot_grid(mem,lum,rest,high_sheet,nrow=4)

test

# ggsave(test,file = file.path(baseDir, "figures/Fig5b_model_figure_betaHeatmapForSig.pdf",height=40,width=20))
```



## Torin data

```{r}
tor<- read.csv(file.path(baseDir, "data/all_ttest_results_Torin.csv"))

tor_ann<-tor%>%left_join(.,organelle_input_er_split,by="Gene.Symbol", relationship="many-to-many")

er<-tor_ann%>%filter(Compartment_ss == "ER")



tor_df_full<-left_join(tor,organelle_input_er_simple,by="Gene.Symbol", relationship="many-to-many")%>%
  distinct()


tor_df_full_erOnly<-left_join(tor,organelle_input_er_split,by="Gene.Symbol", relationship="many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


# write.csv(tor_df_full_erOnly, file.path(baseDir, "output/SuppData_torin_erOnly.csv"))
# 
# write.csv(tor_df_full, file.path(baseDir, "output/SuppData_torin_allData.csv"))
```


### Point Plot

```{r}
### extra based on all proteins by compartment
### Figure 6 point plot
point_plot_tor_input<-tor_ann%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,cluster,Compartment_ss, matches("Log2"))%>%
  dplyr::mutate(delta_penta_flux = log2FC_Pentad12torin.Pentad12-log2FC_WTd12torin.WTd12,
         delta_atg12_flux = log2FC_ATG12d12torin.ATG12d12-log2FC_WTd12torin.WTd12 )%>%
  dplyr::ungroup()%>%
  dplyr::group_by(Compartment_ss)%>%
  dplyr::summarise(med_atg12=median(delta_atg12_flux),
            med_penta = median(delta_penta_flux),
            q1_atg12= quantile(delta_atg12_flux,0.25),
            q3_atg12= quantile(delta_atg12_flux,0.75),
            q1_penta= quantile(delta_penta_flux,0.25),
            q3_penta= quantile(delta_penta_flux,0.75),
            num_proteins = n())

pointplot_double<-ggplot(point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss))+
  geom_point(size=4,alpha=0.6)+
  geom_segment(aes(x=q1_atg12,xend=q3_atg12,y=med_penta,yend=med_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  geom_segment(aes(x=med_atg12,xend=med_atg12,y=q1_penta,yend=q3_penta,color=Compartment_ss),alpha=0.5,size=0.5)+
  theme_classic()+
  geom_hline(yintercept = 0,linetype="dashed")+geom_vline(xintercept = 0,linetype="dashed")+
  geom_text_repel(data=point_plot_tor_input%>%filter(Compartment_ss %!in% c("Cis.Golgi","Trans.Golgi","ERGIC","ER.high.sheet","ER.high.curvature","ER.Receptors")),aes(med_atg12,med_penta,color=Compartment_ss, label=Compartment_ss),max.overlaps = Inf,show.legend=FALSE,size=4)+
  theme(legend.position = "none",axis.title = element_text(size=14),axis.text = element_text(size=14))+
  labs(y="Penta KO Torin/UT - WT Torin/UT",x="ATG12 KO Torin/UT - WT Torin/UT")

pointplot_double

# ggsave(pointplot_double,  filename = file.path(baseDir, "figures/ExtDataFig7b_PointPlot_TorinMinUntreated.pdf", height = 8,width=10))

```


## TEX264_CCPG1 DKO

```{r}
duoKO<-read.csv(file.path(baseDir, "data/all_ttest_results_d12_WTATG12TEXCCPG1.csv"))

duoKO<-left_join(duoKO,organelle_input_er_split,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER","ER.Lumen","ER.Membrane"))%>%
  select(Reference, Gene.Symbol, Annotation, WT, ATG12 , TEXCCPG1,Compartment_ss)%>%
  mutate(ATG12val = ATG12 -WT,
         TEXCCPG1val = TEXCCPG1 - WT)%>%
  select(Reference, Gene.Symbol, Annotation, Compartment_ss,ATG12val,TEXCCPG1val)%>%
  group_by(Reference, Gene.Symbol, Annotation, Compartment_ss)%>%
  gather("comparison","value",5:6)%>%
  mutate(comparison = str_remove(comparison,"val"))


p5<-ggplot(duoKO, aes(comparison,value,fill=Compartment_ss))+
  geom_hline(yintercept = 0,linetype="dashed")+geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.5,color="black")+
  theme_classic()+
  scale_fill_viridis_d(end=0.8)+
  labs(x="",
       y="Log2FC to WT",
       color="Compartment")+
  theme(
    axis.text = element_text(size=16),
    axis.title = element_text(size=18),
    legend.title = element_blank(),
    legend.text = element_text(size=16),
    legend.position = "top"
  )


p5

# ggsave(plot=p5,filename = file.path(baseDir, "figures/ExtDataFig9g_TEXCCPG1_ER_violin.pdf",
# width = 6,height = 5))

calc<-read.csv(file.path(baseDir, "data/all_ttest_results_d12_WTATG12TEXCCPG1.csv"))

ccpg1tex_df_full<-left_join(calc,organelle_input_er_simple,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()


ccpg1tex_df_full_erOnly<-left_join(calc,organelle_input_er_split,by="Gene.Symbol",relationship="many-to-many")%>%
  distinct()%>%
  filter(Compartment_ss %in% c("ER.Lumen","ER.Membrane","ER.Membrane.associated","ER.high.curvature","ER.Receptors","ER.high.sheet"))


# write.csv(ccpg1tex_df_full_erOnly, file.path(baseDir, "output/SuppData_TEXCCPG1_erOnly.csv"))
# 
# write.csv(ccpg1tex_df_full, file.path(baseDir, "output/SuppData_TEXCCPG1_allData.csv"))

```
## Additive KO data AT DAY20

Sample set contains     

```{r}
# USER INPUT
numberOfSamples <- 16

d12_plexa<- read.csv(file.path(baseDir, "data/WTATG12pentad_20_ttest_results.csv"))
numberOfCols <- ncol(d12_plexa)

d12_plexa_slim<-d12_plexa%>%
  dplyr::select(Reference,Gene.Symbol,Annotation,(numberOfCols - numberOfSamples + 1):numberOfCols)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  gather("sample","log2_int",4:(4 + numberOfSamples-1))%>%
  dplyr::mutate(cellLine=dplyr::if_else(str_detect(sample,"WT"),0,1))%>%
  dplyr::ungroup()

### calculate mean WT intensity for nmomalization
wt_Only_d12_plexa_slim<-d12_plexa_slim%>%
  dplyr::filter(cellLine==0)%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  summarise(mean_wt0 = mean(log2_int))

### mean WT subtract form replicate values sans ATG12
norm_d12_plex<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)%>%
  filter(str_detect(sample,"ATG12")==F)

### same as above but with ATG12
norm_d12_plex2<-left_join(d12_plexa_slim,wt_Only_d12_plexa_slim, by=c("Reference","Gene.Symbol","Annotation") )%>%
  dplyr::mutate(log2_int_wtd0_norm = log2_int - mean_wt0)

```

### Violin plots for organelle differences

```{r}
# USER INPUT
wildType <- "WTd20"
conditions <- c("ATG12","pentaA2","pentaE4")
figurePrefix <- "FigNewSupd20"
conditionFilter <- "d20"

## FC extraction

accum_fc<-d12_plexa%>%
  select(Reference,Gene.Symbol,Annotation,
         starts_with("log2FC"))%>%
  select(Reference,Gene.Symbol,Annotation,ends_with(wildType))%>%
  group_by(Reference,Gene.Symbol,Annotation)%>%
  pivot_longer(cols = starts_with("log2FC_"),
               names_to = "Condition",
               values_to = "FCval")%>%
  mutate(Condition = str_remove(Condition,"log2FC_"),
         Condition = str_remove_all(Condition, conditionFilter),
         Condition = str_remove(Condition,"\\.WT"))%>%
  left_join(.,organelle_input_er_more, by="Gene.Symbol",relationship="many-to-many")%>%
  mutate(Compartment_ss = str_replace_all(Compartment_ss,"\\."," "))

accum_fc$Condition <- factor(accum_fc$Condition, 
                             levels=conditions)


### ER only

norm_d12_plex2_ann2<-accum_fc%>%
  filter(str_detect(Compartment_ss,"ER")==T, Compartment_ss != "ERGIC",Compartment_ss != "ER high sheet",Compartment_ss != "ER Receptors",Compartment_ss != "ER high curvature")%>%
         mutate(Compartment_ss=str_replace_all(Compartment_ss,"\\."," "))

norm_d12_plex2_ann2$Condition <- factor(norm_d12_plex2_ann2$Condition,levels=conditions)


pv_fc_er<-ggplot(norm_d12_plex2_ann2%>%filter(Gene.Symbol %!in% c("FAM134C","FAM134B","FAM134A","TEX264","CCPG1"))%>%filter(Condition != "WTd12"), aes(" ", FCval, color=Condition,fill=Condition))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "bottom",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss, nrow=1)+ylim(c(-1.5,2.5))
pv_fc_er

ggsave(plot = pv_fc_er, filename = file.path(baseDir, "figures", paste(figurePrefix, "_KO_accum_ERonly_violin_FC.pdf", sep = "")), height = 6,width=12)

## all locale


norm_d12_plex2_ann4<-accum_fc%>%
  filter( Compartment_ss %in% c("Cytosol","Endosome","ER",
                                "Golgi","Lysosome","Mitochondria",
                                "Nucleus","Peroxisome","Plasma Membrane"))

norm_d12_plex2_ann4$Condition <- factor(norm_d12_plex2_ann4$Condition,levels=conditions)


pv_fc_all<-ggplot(norm_d12_plex2_ann4, aes(" ", FCval, color=Condition,fill=Condition))+
  geom_violin(draw_quantiles = c(0.25,0.5,0.75),alpha=0.8, position = position_dodge(),color="black")+theme_classic()+geom_hline(yintercept = 0,linetype="dashed")+
  scale_fill_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  scale_color_manual(values=c("maroon","#5ec962","#21918c","#3b528b","#440154"))+
  labs(x="",y=bquote(""~Log[2]~"(KO / WT)"))+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=16),
        legend.position = "top",
        axis.title = element_text(size=18),
        axis.text.x = element_text(size = 18,hjust=1,vjust = 0.2,angle=90),
        axis.text.y = element_text(size = 16),
        axis.ticks.x.bottom = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size=16))+
  facet_wrap(.~Compartment_ss,nrow=3)+ylim(c(-1.5,1.5))+ guides(fill = guide_legend(nrow = 1))

pv_fc_all

ggsave(plot = pv_fc_all, filename = file.path(baseDir, "figures", paste(figurePrefix, "_KO_accum_AllOrganelles_violin_FC_nopoints.pdf", sep = "")), height = 12,width=14)

```
